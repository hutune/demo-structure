name: Sync BMAD Artifacts to ClickUp

on:
  push:
    branches: [main]
    paths:
      - '_bmad-output/epics/**/*.md'
      - '_bmad-output/stories/**/*.md'

env:
  CLICKUP_EPICS_LIST_ID: "901815396322"
  CLICKUP_STORIES_LIST_ID: "901815396340"

permissions:
  contents: write

jobs:
  sync-to-clickup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Changed Files
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '_bmad-output/(epics|stories)/.*\.md$' || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Sync to ClickUp
        if: steps.changed.outputs.files != ''
        env:
          CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
        run: |
          echo "Starting ClickUp sync..."
          
          # Process each changed file
          echo "${{ steps.changed.outputs.files }}" | while read -r file; do
            if [ -z "$file" ]; then continue; fi
            
            echo ""
            echo "========================================="
            echo "Processing: $file"
            echo "========================================="
            
            # Extract frontmatter between --- markers
            FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$file" | sed '1d;$d')
            
            # Parse fields inline - remove quotes and trim
            ID=$(echo "$FRONTMATTER" | grep "^id:" | sed 's/^id: *//' | sed 's/^"//; s/"$//' | tr -d '\r')
            TITLE=$(echo "$FRONTMATTER" | grep "^title:" | sed 's/^title: *//' | sed 's/^"//; s/"$//' | tr -d '\r')
            STATUS=$(echo "$FRONTMATTER" | grep "^status:" | sed 's/^status: *//' | sed 's/^"//; s/"$//' | tr -d '\r')
            CLICKUP_ID=$(echo "$FRONTMATTER" | grep "^clickup_task_id:" | sed 's/^clickup_task_id: *//' | sed 's/^"//; s/"$//' | tr -d '\r')
            EPIC_ID=$(echo "$FRONTMATTER" | grep "^epic_id:" | sed 's/^epic_id: *//' | sed 's/^"//; s/"$//' | tr -d '\r')
            
            echo "  ID: $ID"
            echo "  Title: $TITLE"
            echo "  Status: $STATUS"
            echo "  ClickUp ID: $CLICKUP_ID"
            
            # Determine task type and list
            if [[ "$file" == *"/epics/"* ]]; then
              TASK_TYPE="epic"
              LIST_ID="${{ env.CLICKUP_EPICS_LIST_ID }}"
              case "$STATUS" in
                to-do) CLICKUP_STATUS="to do" ;;
                in-progress) CLICKUP_STATUS="in progress" ;;
                done) CLICKUP_STATUS="complete" ;;
                *) CLICKUP_STATUS="to do" ;;
              esac
            else
              TASK_TYPE="story"
              LIST_ID="${{ env.CLICKUP_STORIES_LIST_ID }}"
              case "$STATUS" in
                to-do) CLICKUP_STATUS="Open" ;;
                scoping) CLICKUP_STATUS="scoping" ;;
                in-design) CLICKUP_STATUS="in design" ;;
                ready) CLICKUP_STATUS="ready for dev" ;;
                *) CLICKUP_STATUS="Open" ;;
              esac
            fi
            
            echo "  Type: $TASK_TYPE, List: $LIST_ID, Status: $CLICKUP_STATUS"
            
            # Get description (content after second ---)
            DESCRIPTION=$(sed -n '/^---$/,/^---$/!p' "$file" | tail -n +1 | head -100)
            
            # Build full description
            if [ -n "$EPIC_ID" ]; then
              FULL_DESC="**Epic**: $EPIC_ID

---

$DESCRIPTION

---
_Source: $file_"
            else
              FULL_DESC="$DESCRIPTION

---
_Source: $file_"
            fi
            
            # Build JSON payload using jq
            TASK_NAME="[$TASK_TYPE] $TITLE"
            JSON_PAYLOAD=$(jq -n \
              --arg name "$TASK_NAME" \
              --arg desc "$FULL_DESC" \
              --arg status "$CLICKUP_STATUS" \
              --arg type "$TASK_TYPE" \
              '{name: $name, description: $desc, status: $status, tags: ["bmad", $type]}')
            
            echo "  JSON created"
            
            # Check if we need to CREATE or UPDATE
            if [ -z "$CLICKUP_ID" ] || [ "$CLICKUP_ID" = "null" ]; then
              echo "  Creating new ClickUp task..."
              
              RESPONSE=$(curl -s -X POST \
                "https://api.clickup.com/api/v2/list/$LIST_ID/task" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$JSON_PAYLOAD")
              
              NEW_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
              
              if [ -n "$NEW_ID" ]; then
                echo "  ✅ Created: $NEW_ID"
                echo "  URL: $(echo "$RESPONSE" | jq -r '.url // empty')"
                
                # Update file with new ClickUp ID
                sed -i "s/^clickup_task_id:.*/clickup_task_id: \"$NEW_ID\"/" "$file"
              else
                echo "  ❌ Error creating task:"
                echo "$RESPONSE"
              fi
            else
              echo "  Updating task: $CLICKUP_ID..."
              
              UPDATE_PAYLOAD=$(jq -n \
                --arg name "$TASK_NAME" \
                --arg desc "$FULL_DESC" \
                --arg status "$CLICKUP_STATUS" \
                '{name: $name, description: $desc, status: $status}')
              
              curl -s -X PUT \
                "https://api.clickup.com/api/v2/task/$CLICKUP_ID" \
                -H "Authorization: $CLICKUP_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$UPDATE_PAYLOAD" > /dev/null
              
              echo "  ✅ Updated"
            fi
          done

      - name: Commit Updated ClickUp IDs
        if: steps.changed.outputs.files != ''
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add _bmad-output/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update ClickUp task IDs [skip ci]"
            git push
          fi
